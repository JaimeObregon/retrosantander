#!/usr/bin/env node

/**
 * Recibe el _sitemap_ mal formado de guregipuzkoa.eus, lo interpreta y devuelve
 * una structura JSON equivalente.
 *
 * Véase la documentación en `/docs/guregipuzkoa.md`.
 */
import fs from 'fs'

const args = process.argv.slice(2)

if (args.length !== 1) {
  process.stdout.write(`Uso: node ${process.argv[1]} FICHERO`)
  process.exit(1)
}

// Algunas imágenes de guregipuzkoa.es no son válidas por diferentes razones y
// decidimos excluirlas aquí del _sitemap_, para que no participen del resto de
// pasos del proceso.
const excludeIds = [
  // Imágenes corrompidas o cuyas dimensiones son insuficientes
  'https://www.guregipuzkoa.eus/photo/104194/',
  'https://www.guregipuzkoa.eus/photo/109212/',
  'https://www.guregipuzkoa.eus/photo/110023/',
  'https://www.guregipuzkoa.eus/photo/117889/',
  'https://www.guregipuzkoa.eus/photo/117890/',
  'https://www.guregipuzkoa.eus/photo/117891/',
  'https://www.guregipuzkoa.eus/photo/117892/',
  'https://www.guregipuzkoa.eus/photo/129278/',
  'https://www.guregipuzkoa.eus/photo/129302/',
  'https://www.guregipuzkoa.eus/photo/131239/',
  'https://www.guregipuzkoa.eus/photo/131300/',
  'https://www.guregipuzkoa.eus/photo/132016/',
  'https://www.guregipuzkoa.eus/photo/132072/',
  'https://www.guregipuzkoa.eus/photo/137825/',
  'https://www.guregipuzkoa.eus/photo/137829/',
  'https://www.guregipuzkoa.eus/photo/137870/',
  'https://www.guregipuzkoa.eus/photo/142533/',
  'https://www.guregipuzkoa.eus/photo/142538/',
  'https://www.guregipuzkoa.eus/photo/142541/',
  'https://www.guregipuzkoa.eus/photo/147166/',
  'https://www.guregipuzkoa.eus/photo/147323/',
  'https://www.guregipuzkoa.eus/photo/147324/',
  'https://www.guregipuzkoa.eus/photo/147325/',
  'https://www.guregipuzkoa.eus/photo/147326/',
  'https://www.guregipuzkoa.eus/photo/153061/',
  'https://www.guregipuzkoa.eus/photo/153062/',
  'https://www.guregipuzkoa.eus/photo/153063/',
  'https://www.guregipuzkoa.eus/photo/153064/',
  'https://www.guregipuzkoa.eus/photo/153212/',
  'https://www.guregipuzkoa.eus/photo/153213/',
  'https://www.guregipuzkoa.eus/photo/153214/',
  'https://www.guregipuzkoa.eus/photo/153215/',
  'https://www.guregipuzkoa.eus/photo/153216/',
  'https://www.guregipuzkoa.eus/photo/153217/',
  'https://www.guregipuzkoa.eus/photo/153218/',
  'https://www.guregipuzkoa.eus/photo/153219/',
  'https://www.guregipuzkoa.eus/photo/153220/',
  'https://www.guregipuzkoa.eus/photo/153221/',
  'https://www.guregipuzkoa.eus/photo/153222/',
  'https://www.guregipuzkoa.eus/photo/153223/',
  'https://www.guregipuzkoa.eus/photo/153224/',
  'https://www.guregipuzkoa.eus/photo/153225/',
  'https://www.guregipuzkoa.eus/photo/153226/',
  'https://www.guregipuzkoa.eus/photo/153227/',
  'https://www.guregipuzkoa.eus/photo/153228/',
  'https://www.guregipuzkoa.eus/photo/153229/',
  'https://www.guregipuzkoa.eus/photo/153230/',
  'https://www.guregipuzkoa.eus/photo/153231/',
  'https://www.guregipuzkoa.eus/photo/153232/',
  'https://www.guregipuzkoa.eus/photo/153233/',
  'https://www.guregipuzkoa.eus/photo/153234/',
  'https://www.guregipuzkoa.eus/photo/153235/',
  'https://www.guregipuzkoa.eus/photo/153236/',
  'https://www.guregipuzkoa.eus/photo/153237/',
  'https://www.guregipuzkoa.eus/photo/153238/',
  'https://www.guregipuzkoa.eus/photo/153239/',
  'https://www.guregipuzkoa.eus/photo/153240/',
  'https://www.guregipuzkoa.eus/photo/153241/',
  'https://www.guregipuzkoa.eus/photo/153242/',
  'https://www.guregipuzkoa.eus/photo/153243/',
  'https://www.guregipuzkoa.eus/photo/153244/',
  'https://www.guregipuzkoa.eus/photo/153245/',
  'https://www.guregipuzkoa.eus/photo/153246/',
  'https://www.guregipuzkoa.eus/photo/153247/',
  'https://www.guregipuzkoa.eus/photo/153248/',
  'https://www.guregipuzkoa.eus/photo/153249/',
  'https://www.guregipuzkoa.eus/photo/153250/',
  'https://www.guregipuzkoa.eus/photo/153251/',
  'https://www.guregipuzkoa.eus/photo/153252/',
  'https://www.guregipuzkoa.eus/photo/153253/',
  'https://www.guregipuzkoa.eus/photo/153254/',
  'https://www.guregipuzkoa.eus/photo/153255/',
  'https://www.guregipuzkoa.eus/photo/153256/',
  'https://www.guregipuzkoa.eus/photo/153257/',
  'https://www.guregipuzkoa.eus/photo/153258/',
  'https://www.guregipuzkoa.eus/photo/153259/',
  'https://www.guregipuzkoa.eus/photo/153260/',
  'https://www.guregipuzkoa.eus/photo/153261/',
  'https://www.guregipuzkoa.eus/photo/153262/',
  'https://www.guregipuzkoa.eus/photo/153263/',
  'https://www.guregipuzkoa.eus/photo/153264/',
  'https://www.guregipuzkoa.eus/photo/153265/',
  'https://www.guregipuzkoa.eus/photo/153266/',
  'https://www.guregipuzkoa.eus/photo/153267/',
  'https://www.guregipuzkoa.eus/photo/153268/',
  'https://www.guregipuzkoa.eus/photo/153269/',
  'https://www.guregipuzkoa.eus/photo/153270/',
  'https://www.guregipuzkoa.eus/photo/153271/',
  'https://www.guregipuzkoa.eus/photo/153272/',
  'https://www.guregipuzkoa.eus/photo/153273/',
  'https://www.guregipuzkoa.eus/photo/153274/',
  'https://www.guregipuzkoa.eus/photo/153275/',
  'https://www.guregipuzkoa.eus/photo/153276/',
  'https://www.guregipuzkoa.eus/photo/153277/',
  'https://www.guregipuzkoa.eus/photo/153278/',
  'https://www.guregipuzkoa.eus/photo/153279/',
  'https://www.guregipuzkoa.eus/photo/153282/',
  'https://www.guregipuzkoa.eus/photo/153283/',
  'https://www.guregipuzkoa.eus/photo/153284/',
  'https://www.guregipuzkoa.eus/photo/153285/',
  'https://www.guregipuzkoa.eus/photo/153286/',
  'https://www.guregipuzkoa.eus/photo/153287/',
  'https://www.guregipuzkoa.eus/photo/153288/',
  'https://www.guregipuzkoa.eus/photo/153290/',
  'https://www.guregipuzkoa.eus/photo/153291/',
  'https://www.guregipuzkoa.eus/photo/153293/',
  'https://www.guregipuzkoa.eus/photo/153294/',
  'https://www.guregipuzkoa.eus/photo/153296/',
  'https://www.guregipuzkoa.eus/photo/153297/',
  'https://www.guregipuzkoa.eus/photo/153298/',
  'https://www.guregipuzkoa.eus/photo/155945/',
  'https://www.guregipuzkoa.eus/photo/21294/',
  'https://www.guregipuzkoa.eus/photo/27056/',
  'https://www.guregipuzkoa.eus/photo/27057/',
  'https://www.guregipuzkoa.eus/photo/27058/',
  'https://www.guregipuzkoa.eus/photo/29977/',
  'https://www.guregipuzkoa.eus/photo/29993/',
  'https://www.guregipuzkoa.eus/photo/30005/',
  'https://www.guregipuzkoa.eus/photo/30030/',
  'https://www.guregipuzkoa.eus/photo/30031/',
  'https://www.guregipuzkoa.eus/photo/31440/',
  'https://www.guregipuzkoa.eus/photo/31441/',
  'https://www.guregipuzkoa.eus/photo/32632/',
  'https://www.guregipuzkoa.eus/photo/33189/',
  'https://www.guregipuzkoa.eus/photo/33191/',
  'https://www.guregipuzkoa.eus/photo/35382/',
  'https://www.guregipuzkoa.eus/photo/37352/',
  'https://www.guregipuzkoa.eus/photo/37353/',
  'https://www.guregipuzkoa.eus/photo/40162/',
  'https://www.guregipuzkoa.eus/photo/40163/',
  'https://www.guregipuzkoa.eus/photo/41863/',
  'https://www.guregipuzkoa.eus/photo/44534/',
  'https://www.guregipuzkoa.eus/photo/45861/',
  'https://www.guregipuzkoa.eus/photo/45917/',
  'https://www.guregipuzkoa.eus/photo/46385/',
  'https://www.guregipuzkoa.eus/photo/46537/',
  'https://www.guregipuzkoa.eus/photo/46830/',
  'https://www.guregipuzkoa.eus/photo/51665/',
  'https://www.guregipuzkoa.eus/photo/51685/',
  'https://www.guregipuzkoa.eus/photo/51701/',
  'https://www.guregipuzkoa.eus/photo/51728/',
  'https://www.guregipuzkoa.eus/photo/58749/',
  'https://www.guregipuzkoa.eus/photo/6111/',
  'https://www.guregipuzkoa.eus/photo/6146/',
  'https://www.guregipuzkoa.eus/photo/61663/',
  'https://www.guregipuzkoa.eus/photo/61669/',
  'https://www.guregipuzkoa.eus/photo/6178/',
  'https://www.guregipuzkoa.eus/photo/6213/',
  'https://www.guregipuzkoa.eus/photo/68199/',
  'https://www.guregipuzkoa.eus/photo/68217/',
  'https://www.guregipuzkoa.eus/photo/68226/',
  'https://www.guregipuzkoa.eus/photo/68235/',
  'https://www.guregipuzkoa.eus/photo/70098/',
  'https://www.guregipuzkoa.eus/photo/74880/',
  'https://www.guregipuzkoa.eus/photo/74896/',
  'https://www.guregipuzkoa.eus/photo/76106/',
  'https://www.guregipuzkoa.eus/photo/76120/',
  'https://www.guregipuzkoa.eus/photo/82049/',
  'https://www.guregipuzkoa.eus/photo/82068/',
  'https://www.guregipuzkoa.eus/photo/92431/',
  'https://www.guregipuzkoa.eus/photo/92458/',
  'https://www.guregipuzkoa.eus/photo/92478/',
  'https://www.guregipuzkoa.eus/photo/93503/',
  'https://www.guregipuzkoa.eus/photo/10530/',
  'https://www.guregipuzkoa.eus/photo/107031/',
  'https://www.guregipuzkoa.eus/photo/107032/',
  'https://www.guregipuzkoa.eus/photo/109170/',
  'https://www.guregipuzkoa.eus/photo/110534/',
  'https://www.guregipuzkoa.eus/photo/110755/',
  'https://www.guregipuzkoa.eus/photo/110783/',
  'https://www.guregipuzkoa.eus/photo/111499/',
  'https://www.guregipuzkoa.eus/photo/112817/',
  'https://www.guregipuzkoa.eus/photo/114420/',
  'https://www.guregipuzkoa.eus/photo/117647/',
  'https://www.guregipuzkoa.eus/photo/119349/',
  'https://www.guregipuzkoa.eus/photo/133933/',
  'https://www.guregipuzkoa.eus/photo/134183/',
  'https://www.guregipuzkoa.eus/photo/134336/',
  'https://www.guregipuzkoa.eus/photo/134422/',
  'https://www.guregipuzkoa.eus/photo/134438/',
  'https://www.guregipuzkoa.eus/photo/134817/',
  'https://www.guregipuzkoa.eus/photo/135170/',
  'https://www.guregipuzkoa.eus/photo/136008/',
  'https://www.guregipuzkoa.eus/photo/136242/',
  'https://www.guregipuzkoa.eus/photo/136379/',
  'https://www.guregipuzkoa.eus/photo/136549/',
  'https://www.guregipuzkoa.eus/photo/137537/',
  'https://www.guregipuzkoa.eus/photo/137654/',
  'https://www.guregipuzkoa.eus/photo/138402/',
  'https://www.guregipuzkoa.eus/photo/139857/',
  'https://www.guregipuzkoa.eus/photo/140075/',
  'https://www.guregipuzkoa.eus/photo/140678/',
  'https://www.guregipuzkoa.eus/photo/141030/',
  'https://www.guregipuzkoa.eus/photo/14133/',
  'https://www.guregipuzkoa.eus/photo/141432/',
  'https://www.guregipuzkoa.eus/photo/142227/',
  'https://www.guregipuzkoa.eus/photo/142373/',
  'https://www.guregipuzkoa.eus/photo/142432/',
  'https://www.guregipuzkoa.eus/photo/142743/',
  'https://www.guregipuzkoa.eus/photo/143132/',
  'https://www.guregipuzkoa.eus/photo/143172/',
  'https://www.guregipuzkoa.eus/photo/143215/',
  'https://www.guregipuzkoa.eus/photo/143216/',
  'https://www.guregipuzkoa.eus/photo/143217/',
  'https://www.guregipuzkoa.eus/photo/143218/',
  'https://www.guregipuzkoa.eus/photo/143220/',
  'https://www.guregipuzkoa.eus/photo/143223/',
  'https://www.guregipuzkoa.eus/photo/143225/',
  'https://www.guregipuzkoa.eus/photo/143226/',
  'https://www.guregipuzkoa.eus/photo/143230/',
  'https://www.guregipuzkoa.eus/photo/143231/',
  'https://www.guregipuzkoa.eus/photo/143235/',
  'https://www.guregipuzkoa.eus/photo/143236/',
  'https://www.guregipuzkoa.eus/photo/143238/',
  'https://www.guregipuzkoa.eus/photo/143240/',
  'https://www.guregipuzkoa.eus/photo/143241/',
  'https://www.guregipuzkoa.eus/photo/143245/',
  'https://www.guregipuzkoa.eus/photo/143291/',
  'https://www.guregipuzkoa.eus/photo/143317/',
  'https://www.guregipuzkoa.eus/photo/143666/',
  'https://www.guregipuzkoa.eus/photo/143700/',
  'https://www.guregipuzkoa.eus/photo/143956/',
  'https://www.guregipuzkoa.eus/photo/143961/',
  'https://www.guregipuzkoa.eus/photo/143969/',
  'https://www.guregipuzkoa.eus/photo/144753/',
  'https://www.guregipuzkoa.eus/photo/144853/',
  'https://www.guregipuzkoa.eus/photo/145365/',
  'https://www.guregipuzkoa.eus/photo/145369/',
  'https://www.guregipuzkoa.eus/photo/146656/',
  'https://www.guregipuzkoa.eus/photo/146744/',
  'https://www.guregipuzkoa.eus/photo/146788/',
  'https://www.guregipuzkoa.eus/photo/147098/',
  'https://www.guregipuzkoa.eus/photo/147647/',
  'https://www.guregipuzkoa.eus/photo/148366/',
  'https://www.guregipuzkoa.eus/photo/148537/',
  'https://www.guregipuzkoa.eus/photo/148684/',
  'https://www.guregipuzkoa.eus/photo/148711/',
  'https://www.guregipuzkoa.eus/photo/149069/',
  'https://www.guregipuzkoa.eus/photo/149864/',
  'https://www.guregipuzkoa.eus/photo/150301/',
  'https://www.guregipuzkoa.eus/photo/150443/',
  'https://www.guregipuzkoa.eus/photo/151109/',
  'https://www.guregipuzkoa.eus/photo/151114/',
  'https://www.guregipuzkoa.eus/photo/151364/',
  'https://www.guregipuzkoa.eus/photo/151429/',
  'https://www.guregipuzkoa.eus/photo/151583/',
  'https://www.guregipuzkoa.eus/photo/152272/',
  'https://www.guregipuzkoa.eus/photo/152286/',
  'https://www.guregipuzkoa.eus/photo/152322/',
  'https://www.guregipuzkoa.eus/photo/152364/',
  'https://www.guregipuzkoa.eus/photo/152367/',
  'https://www.guregipuzkoa.eus/photo/152398/',
  'https://www.guregipuzkoa.eus/photo/152535/',
  'https://www.guregipuzkoa.eus/photo/152657/',
  'https://www.guregipuzkoa.eus/photo/153022/',
  'https://www.guregipuzkoa.eus/photo/153114/',
  'https://www.guregipuzkoa.eus/photo/153280/',
  'https://www.guregipuzkoa.eus/photo/153281/',
  'https://www.guregipuzkoa.eus/photo/153289/',
  'https://www.guregipuzkoa.eus/photo/153292/',
  'https://www.guregipuzkoa.eus/photo/153295/',
  'https://www.guregipuzkoa.eus/photo/154470/',
  'https://www.guregipuzkoa.eus/photo/154475/',
  'https://www.guregipuzkoa.eus/photo/154994/',
  'https://www.guregipuzkoa.eus/photo/155943/',
  'https://www.guregipuzkoa.eus/photo/158074/',
  'https://www.guregipuzkoa.eus/photo/21094/',
  'https://www.guregipuzkoa.eus/photo/2994/',
  'https://www.guregipuzkoa.eus/photo/34834/',
  'https://www.guregipuzkoa.eus/photo/34842/',
  'https://www.guregipuzkoa.eus/photo/41692/',
  'https://www.guregipuzkoa.eus/photo/47374/',
  'https://www.guregipuzkoa.eus/photo/47654/',
  'https://www.guregipuzkoa.eus/photo/47700/',
  'https://www.guregipuzkoa.eus/photo/48153/',
  'https://www.guregipuzkoa.eus/photo/48320/',
  'https://www.guregipuzkoa.eus/photo/49601/',
  'https://www.guregipuzkoa.eus/photo/51206/',
  'https://www.guregipuzkoa.eus/photo/51503/',
  'https://www.guregipuzkoa.eus/photo/53114/',
  'https://www.guregipuzkoa.eus/photo/56651/',
  'https://www.guregipuzkoa.eus/photo/62064/',
  'https://www.guregipuzkoa.eus/photo/62065/',
  'https://www.guregipuzkoa.eus/photo/67714/',
  'https://www.guregipuzkoa.eus/photo/67860/',
  'https://www.guregipuzkoa.eus/photo/67897/',
  'https://www.guregipuzkoa.eus/photo/68223/',
  'https://www.guregipuzkoa.eus/photo/68921/',
  'https://www.guregipuzkoa.eus/photo/68933/',
  'https://www.guregipuzkoa.eus/photo/68939/',
  'https://www.guregipuzkoa.eus/photo/69219/',
  'https://www.guregipuzkoa.eus/photo/69566/',
  'https://www.guregipuzkoa.eus/photo/70741/',
  'https://www.guregipuzkoa.eus/photo/70747/',
  'https://www.guregipuzkoa.eus/photo/70851/',
  'https://www.guregipuzkoa.eus/photo/73991/',
  'https://www.guregipuzkoa.eus/photo/74430/',
  'https://www.guregipuzkoa.eus/photo/74488/',
  'https://www.guregipuzkoa.eus/photo/74500/',
  'https://www.guregipuzkoa.eus/photo/74793/',
  'https://www.guregipuzkoa.eus/photo/75377/',
  'https://www.guregipuzkoa.eus/photo/75809/',
  'https://www.guregipuzkoa.eus/photo/76498/',
  'https://www.guregipuzkoa.eus/photo/77532/',
  'https://www.guregipuzkoa.eus/photo/77737/',
  'https://www.guregipuzkoa.eus/photo/77841/',
  'https://www.guregipuzkoa.eus/photo/78067/',
  'https://www.guregipuzkoa.eus/photo/78376/',
  'https://www.guregipuzkoa.eus/photo/78515/',
  'https://www.guregipuzkoa.eus/photo/78958/',
  'https://www.guregipuzkoa.eus/photo/79049/',
  'https://www.guregipuzkoa.eus/photo/79103/',
  'https://www.guregipuzkoa.eus/photo/79153/',
  'https://www.guregipuzkoa.eus/photo/80008/',
  'https://www.guregipuzkoa.eus/photo/80254/',
  'https://www.guregipuzkoa.eus/photo/80396/',
  'https://www.guregipuzkoa.eus/photo/81046/',
  'https://www.guregipuzkoa.eus/photo/81360/',
  'https://www.guregipuzkoa.eus/photo/81538/',
  'https://www.guregipuzkoa.eus/photo/81542/',
  'https://www.guregipuzkoa.eus/photo/81585/',
  'https://www.guregipuzkoa.eus/photo/81695/',
  'https://www.guregipuzkoa.eus/photo/82037/',
  'https://www.guregipuzkoa.eus/photo/82079/',
  'https://www.guregipuzkoa.eus/photo/82110/',
  'https://www.guregipuzkoa.eus/photo/82141/',
  'https://www.guregipuzkoa.eus/photo/82165/',
  'https://www.guregipuzkoa.eus/photo/82178/',
  'https://www.guregipuzkoa.eus/photo/83113/',
  'https://www.guregipuzkoa.eus/photo/84483/',
  'https://www.guregipuzkoa.eus/photo/84783/',
  'https://www.guregipuzkoa.eus/photo/85816/',
  'https://www.guregipuzkoa.eus/photo/86221/',
  'https://www.guregipuzkoa.eus/photo/86276/',
  'https://www.guregipuzkoa.eus/photo/86523/',
  'https://www.guregipuzkoa.eus/photo/86779/',
  'https://www.guregipuzkoa.eus/photo/87026/',
  'https://www.guregipuzkoa.eus/photo/87901/',
  'https://www.guregipuzkoa.eus/photo/88181/',
  'https://www.guregipuzkoa.eus/photo/88636/',
  'https://www.guregipuzkoa.eus/photo/88649/',
  'https://www.guregipuzkoa.eus/photo/89821/',
  'https://www.guregipuzkoa.eus/photo/92107/',
  'https://www.guregipuzkoa.eus/photo/92418/',
  'https://www.guregipuzkoa.eus/photo/92841/',
  'https://www.guregipuzkoa.eus/photo/93060/',
  'https://www.guregipuzkoa.eus/photo/93131/',
  'https://www.guregipuzkoa.eus/photo/93200/',
  'https://www.guregipuzkoa.eus/photo/93239/',
  'https://www.guregipuzkoa.eus/photo/93513/',
  'https://www.guregipuzkoa.eus/photo/93816/',
  'https://www.guregipuzkoa.eus/photo/94423/',
  'https://www.guregipuzkoa.eus/photo/94424/',
  'https://www.guregipuzkoa.eus/photo/94651/',
  'https://www.guregipuzkoa.eus/photo/94667/',
  'https://www.guregipuzkoa.eus/photo/94700/',
  'https://www.guregipuzkoa.eus/photo/95405/',
  'https://www.guregipuzkoa.eus/photo/96895/',
  'https://www.guregipuzkoa.eus/photo/97867/',
  'https://www.guregipuzkoa.eus/photo/98958/',
  'https://www.guregipuzkoa.eus/photo/98959/',
]

const pattern = new RegExp(
  [
    /<url>\s*/,
    /<loc>(?<id>.+?)<\/loc>\s*/,
    /<priority>.+?<\/priority>\s*/,
    /<image:image>\s*/,
    /<image:loc>(?<image>.*?)<\/image:loc>\s*/,
    /<image:title>(?<title>.*?)<\/image:title>\s*/,
    /<image:caption>(?<caption>.*?)<\/image:caption>\s*/,
    /<\/image:image>\s*/,
    /<\/url>/,
  ]
    .map((chunk) => chunk.source)
    .join(''),
  'gs'
)

const file = process.argv[2]
const contents = fs.readFileSync(file).toString()

const matches = contents
  // Además de no ser XML válido, el _sitemap_ del guregipuzkoa.eus
  // contiene errores que detectamos y corregimos aquí.
  .replaceAll('guregipuzkoa.euswp-content', 'guregipuzkoa.eus/wp-content')
  .matchAll(pattern)

const results = [...matches]
  .filter((match) => !excludeIds.includes(match.groups.id))
  .map((match) => match.groups)
const string = JSON.stringify(results)

process.stdout.write(string)
